name: CI/CD Pipeline

on:
  push:
    branches: [main, develop]
    tags:
      - 'v*.*.*'
  pull_request:
    branches: [main, develop]
  workflow_dispatch:

permissions:
  contents: read

env:
  NODE_VERSION: '20.x'

jobs:
  # Job 1: Code Quality & Testing
  quality-gate:
    name: Quality Gate (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
    steps:
      - name: Install Xvfb
        run: sudo apt-get update && sudo apt-get install -y xvfb

      - name: Start Xvfb
        run: |
            export DISPLAY=:99
            Xvfb :99 -screen 0 1920x1080x16 &

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Type checking
        run: npm run check:types

      - name: Lint code
        run: npm run lint

      - name: Compile TypeScript
        run: npm run test-compile

      - name: Run tests
        run: npm test

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results-${{ matrix.os }}
          path: test-results/
          retention-days: 30

  # Job 2: Code Coverage (Ubuntu only)
  coverage:
    name: Code Coverage
    runs-on: ubuntu-latest
    needs: quality-gate
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Compile TypeScript
        run: npm run test-compile

      - name: Collect coverage
        run: npm run test:coverage

      - name: Upload coverage to artifact
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: coverage/
          retention-days: 30

  # Job 3: Security Scanning
  security:
    name: Security Audit
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run npm audit
        run: npm audit --production --audit-level=high
        continue-on-error: false

      - name: Generate SBOM
        run: |
          mkdir -p sbom
          npx @cyclonedx/cyclonedx-npm --output-file sbom/bom.json --spec-version 1.5

      - name: Upload SBOM artifact
        uses: actions/upload-artifact@v4
        with:
          name: sbom
          path: sbom/
          retention-days: 90

  # Job 4: CodeQL Analysis
  codeql:
    name: CodeQL Security Scan
    runs-on: ubuntu-latest
    permissions:
      actions: read
      contents: read
      security-events: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Initialize CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: javascript-typescript
          queries: security-and-quality

      - name: Autobuild
        uses: github/codeql-action/autobuild@v3

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3

  # Job 5: Build & Package
  build:
    name: Build Extension
    needs: [quality-gate, security, codeql]
    runs-on: ubuntu-latest
    outputs:
      vsix-name: ${{ steps.package.outputs.vsix-name }}
      vsix-size: ${{ steps.size.outputs.size }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build extension
        run: npm run package

      - name: Package extension
        id: package
        run: |
          npx @vscode/vsce package --out nexkit-vscode.vsix
          echo "vsix-name=nexkit-vscode.vsix" >> $GITHUB_OUTPUT

      - name: Get package size
        id: size
        run: |
          SIZE=$(stat -c%s nexkit-vscode.vsix)
          echo "size=$SIZE" >> $GITHUB_OUTPUT
          echo "Extension size: $(numfmt --to=iec-i --suffix=B $SIZE)"

      - name: Check bundle size
        run: |
          MAX_SIZE=524288
          ACTUAL_SIZE=${{ steps.size.outputs.size }}
          if [ $ACTUAL_SIZE -gt $MAX_SIZE ]; then
            echo "::warning::Extension size ($ACTUAL_SIZE bytes) exceeds target ($MAX_SIZE bytes)"
          fi

      - name: Upload VSIX artifact
        uses: actions/upload-artifact@v4
        with:
          name: nexkit-vscode-vsix
          path: nexkit-vscode.vsix
          retention-days: 30

  # Job 6: Create GitHub Release
  release:
    name: Create GitHub Release
    needs: [build, coverage]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    permissions:
      contents: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Download VSIX
        uses: actions/download-artifact@v4
        with:
          name: nexkit-vscode-vsix

      - name: Download SBOM
        uses: actions/download-artifact@v4
        with:
          name: sbom
          path: sbom

      - name: Generate changelog
        id: changelog
        run: |
          npx conventional-changelog-cli -p angular -r 2 -o RELEASE_NOTES.md
          cat RELEASE_NOTES.md

      - name: Determine release type
        id: release-type
        run: |
          TAG="${GITHUB_REF#refs/tags/}"
          if [[ "$TAG" =~ -(alpha|beta|rc) ]]; then
            echo "is_prerelease=true" >> $GITHUB_OUTPUT
            echo "Release type: Pre-release"
          else
            echo "is_prerelease=false" >> $GITHUB_OUTPUT
            echo "Release type: Stable"
          fi

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            nexkit-vscode.vsix
            sbom/bom.json
          body_path: RELEASE_NOTES.md
          draft: false
          prerelease: ${{ steps.release-type.outputs.is_prerelease }}
          make_latest: ${{ steps.release-type.outputs.is_prerelease == 'false' }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Create release summary
        run: |
          TAG="${GITHUB_REF#refs/tags/}"
          echo "### ðŸŽ‰ Release Created Successfully" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** ${TAG}" >> $GITHUB_STEP_SUMMARY
          echo "**Type:** ${{ steps.release-type.outputs.is_prerelease == 'true' && 'Pre-release' || 'Stable' }}" >> $GITHUB_STEP_SUMMARY
          echo "**Extension Size:** $(numfmt --to=iec-i --suffix=B ${{ needs.build.outputs.vsix-size }})" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "#### Download Links" >> $GITHUB_STEP_SUMMARY
          echo "- [VSIX Package](${{ github.server_url }}/${{ github.repository }}/releases/download/${TAG}/nexkit-vscode.vsix)" >> $GITHUB_STEP_SUMMARY
          echo "- [Latest Release](${{ github.server_url }}/${{ github.repository }}/releases/latest/download/nexkit-vscode.vsix)" >> $GITHUB_STEP_SUMMARY
          echo "- [Release Page](${{ github.server_url }}/${{ github.repository }}/releases/tag/${TAG})" >> $GITHUB_STEP_SUMMARY

  # Job 7: Notify on Success
  notify:
    name: Notify Release
    needs: release
    runs-on: ubuntu-latest
    if: success() && startsWith(github.ref, 'refs/tags/v')
    steps:
      - name: Extract version
        id: version
        run: echo "version=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: Send notification
        run: |
          echo "ðŸŽ‰ Successfully released Nexkit VS Code Extension v${{ steps.version.outputs.version }}"
          echo "Download: ${{ github.server_url }}/${{ github.repository }}/releases/download/${{ github.ref_name }}/nexkit-vscode.vsix"
          echo "Latest: ${{ github.server_url }}/${{ github.repository }}/releases/latest/download/nexkit-vscode.vsix"
