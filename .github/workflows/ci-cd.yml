name: CI/CD Pipeline

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
    paths-ignore:
      - "/*.md"
      - "/docs/**/*"

  workflow_dispatch:

permissions:
  contents: read

env:
  NODE_VERSION: "22.x"

jobs:
  # Job 1: Code Quality & Testing
  quality-gate:
    name: Quality Gate (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    if: github.event_name != 'push' || !contains(github.event.head_commit.message, '[skip ci]')
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
    steps:
      - name: Install Xvfb
        if: matrix.os == 'ubuntu-latest'
        run: sudo apt-get update && sudo apt-get install -y xvfb

      - name: Start Xvfb
        if: matrix.os == 'ubuntu-latest'
        run: |
          export DISPLAY=:99
          Xvfb :99 -screen 0 1920x1080x16 &

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Type checking
        run: npm run check:types

      - name: Lint code
        run: npm run lint

      - name: Compile TypeScript
        run: npm run test-compile

      - name: Run tests
        if: matrix.os != 'ubuntu-latest'
        run: npm test
      - name: Run tests (headless)
        if: matrix.os == 'ubuntu-latest'
        run: xvfb-run -a npm test

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results-${{ matrix.os }}
          path: test-results/
          retention-days: 30

  # Job 2: Code Coverage (Ubuntu only)
  # coverage:
  #   name: Code Coverage
  #   runs-on: ubuntu-latest
  #   needs: quality-gate
  #   steps:
  #     - name: Install Xvfb
  #       run: sudo apt-get update && sudo apt-get install -y xvfb

  #     - name: Start Xvfb
  #       run: |
  #         export DISPLAY=:99
  #         Xvfb :99 -screen 0 1920x1080x16 &

  #     - name: Checkout repository
  #       uses: actions/checkout@v4

  #     - name: Setup Node.js
  #       uses: actions/setup-node@v4
  #       with:
  #         node-version: ${{ env.NODE_VERSION }}
  #         cache: 'npm'

  #     - name: Install dependencies
  #       run: npm ci

  #     - name: Compile TypeScript
  #       run: npm run test-compile

  #     - name: Collect coverage
  #       run: npm run test:coverage

  #     - name: Upload coverage to artifact
  #       uses: actions/upload-artifact@v4
  #       with:
  #         name: coverage-report
  #         path: coverage/
  #         retention-days: 30

  # Job 3: Security Scanning
  security:
    name: Security Audit
    runs-on: ubuntu-latest
    if: github.event_name != 'push' || !contains(github.event.head_commit.message, '[skip ci]')
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Run npm audit
        run: npm audit --omit=dev --audit-level=high
        continue-on-error: false

      - name: Generate SBOM
        run: |
          mkdir -p sbom
          npx @cyclonedx/cyclonedx-npm --output-file sbom/manifest.json --spec-version 1.5

      - name: Upload SBOM artifact
        uses: actions/upload-artifact@v4
        with:
          name: sbom
          path: sbom/
          retention-days: 90
  # Job 4: CodeQL Analysis

  # Job 5: Build & Package
  build:
    name: Build Extension
    needs: [security]
    runs-on: ubuntu-latest
    if: |
      (
        github.event_name == 'push' &&
        (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop') &&
        (!contains(github.event.head_commit.message, '[skip ci]'))
      ) || (
        github.event_name == 'pull_request' &&
        (github.base_ref == 'main' || github.base_ref == 'develop')
      )
    outputs:
      vsix-name: ${{ steps.package.outputs.vsix-name }}
      vsix-size: ${{ steps.size.outputs.size }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Build extension
        run: npm run package

      - name: Package extension
        id: package
        run: |
          npx @vscode/vsce package --out nexkit-vscode.vsix
          echo "vsix-name=nexkit-vscode.vsix" >> $GITHUB_OUTPUT

      - name: Get package size
        id: size
        run: |
          SIZE=$(stat -c%s nexkit-vscode.vsix)
          echo "size=$SIZE" >> $GITHUB_OUTPUT
          echo "Extension size: $(numfmt --to=iec-i --suffix=B $SIZE)"

      - name: Check bundle size
        run: |
          MAX_SIZE=524288
          ACTUAL_SIZE=${{ steps.size.outputs.size }}
          if [ $ACTUAL_SIZE -gt $MAX_SIZE ]; then
            echo "::warning::Extension size ($ACTUAL_SIZE bytes) exceeds target ($MAX_SIZE bytes)"
          fi

      - name: Upload VSIX artifact
        uses: actions/upload-artifact@v4
        with:
          name: nexkit-vscode-vsix
          path: nexkit-vscode.vsix
          retention-days: 30

  # Job 6: Release (semantic-release) - Only for push to main/develop
  release:
    name: Release (semantic-release)
    needs: [quality-gate, security]
    runs-on: ubuntu-latest
    # Run on push to main/develop OR on PRs targeting develop (for beta testing)
    if: |
      (
        github.event_name == 'push' &&
        (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop') &&
        (!contains(github.event.head_commit.message, '[skip ci]'))
      ) || (
        github.event_name == 'pull_request' &&
        (github.base_ref == 'main' || github.base_ref == 'develop')
      )
    concurrency:
      group: release-${{ github.event_name }}-${{ github.ref }}-${{ github.event.pull_request.number || '' }}
      cancel-in-progress: false
    permissions:
      contents: write
      issues: write
      pull-requests: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          # For PRs, checkout the merge commit to test what would be merged
          ref: ${{ github.event_name == 'pull_request' && github.event.pull_request.head.sha || github.ref }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      - name: Configure git author
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Install dependencies
        run: npm ci

      - name: Run semantic-release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: npx semantic-release

      - name: Capture version and rename VSIX
        id: rename-vsix
        run: |
          if [ ! -f nexkit-vscode.vsix ]; then
            echo "VSIX not found; semantic-release did not produce nexkit-vscode.vsix"
            exit 1
          fi

          VERSION=$(node -p "require('./package.json').version")
          TARGET="nexkit-vscode-${VERSION}.vsix"

          mv nexkit-vscode.vsix "$TARGET"
          echo "vsix-name=$TARGET" >> $GITHUB_OUTPUT

      - name: Upload versioned VSIX artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.rename-vsix.outputs.vsix-name }}
          path: ${{ steps.rename-vsix.outputs.vsix-name }}
          retention-days: 30

  # Job 7: Preview Build for PRs to develop (creates beta-preview packages)
  pr-preview:
    name: PR Preview Build
    needs: [quality-gate, security]
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request' && github.event.pull_request.base.ref == 'develop'
    permissions:
      contents: read
      pull-requests: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Calculate preview version
        id: preview-version
        run: |
          # Get base version from package.json
          BASE_VERSION=$(node -p "require('./package.json').version")

          # Get PR number
          PR_NUMBER=${{ github.event.pull_request.number }}

          # Get short commit SHA
          SHORT_SHA=$(git rev-parse --short HEAD)

          # Create preview version: base-beta-pr<number>+<sha>
          PREVIEW_VERSION="${BASE_VERSION}-beta-pr${PR_NUMBER}+${SHORT_SHA}"

          echo "version=$PREVIEW_VERSION" >> $GITHUB_OUTPUT
          echo "ðŸ“¦ Preview version: $PREVIEW_VERSION"

      - name: Update package.json with preview version
        run: |
          npm version ${{ steps.preview-version.outputs.version }} --no-git-tag-version

      - name: Build extension
        run: npm run package

      - name: Package VSIX
        run: |
          npx @vscode/vsce package --out nexkit-vscode-${{ steps.preview-version.outputs.version }}.vsix

      - name: Upload preview VSIX
        uses: actions/upload-artifact@v4
        with:
          name: nexkit-vscode-${{ steps.preview-version.outputs.version }}
          path: nexkit-vscode-${{ steps.preview-version.outputs.version }}.vsix
          retention-days: 30

      - name: Comment on PR
        uses: actions/github-script@v7
        with:
          script: |
            const version = '${{ steps.preview-version.outputs.version }}';
            const runUrl = `${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`;

            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `ðŸŽ‰ **Preview Build Ready**\n\n` +
                    `ðŸ“¦ Version: \`${version}\`\n` +
                    `ðŸ“¥ [Download VSIX](${runUrl})\n\n` +
                    `This preview build is available in the workflow artifacts for testing.`
            });
